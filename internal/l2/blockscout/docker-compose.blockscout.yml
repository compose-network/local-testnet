services:
  a-db:
    image: postgres:17
    container_name: blockscout-a-db
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    environment:
      POSTGRES_DB: blockscout
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: blockscout
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -d blockscout"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - blockscout-a-db:/var/lib/postgresql/data

  a-redis:
    image: redis:7-alpine
    container_name: blockscout-a-redis
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  a-frontend:
    image: ghcr.io/blockscout/frontend:v2.3.5
    container_name: blockscout-a-frontend
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      blockscout-a:
        condition: service_started
    env_file:
      - ./networks/rollup-a/blockscout-frontend.env

  a-proxy:
    image: nginx:1.27-alpine
    container_name: blockscout-a-proxy
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      a-frontend:
        condition: service_started
      a-service:
        condition: service_healthy
    ports:
      - "19000:80"
    volumes:
      - ./networks/rollup-a/blockscout-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  a-service:
    image: ghcr.io/blockscout/blockscout-optimism:9.0.2
    container_name: blockscout-a
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      a-db:
        condition: service_healthy
      a-redis:
        condition: service_started
    env_file:
      - ./networks/rollup-a/blockscout.env
    environment:
      RELEASE_LINK: "Compose Rollup A"
    command: >
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    expose:
      - "4000"
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:4000/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  b-db:
    image: postgres:17
    container_name: blockscout-b-db
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    environment:
      POSTGRES_DB: blockscout
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: blockscout
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -d blockscout"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - blockscout-b-db:/var/lib/postgresql/data

  b-redis:
    image: redis:7-alpine
    container_name: blockscout-b-redis
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  b-frontend:
    image: ghcr.io/blockscout/frontend:v2.3.5
    container_name: blockscout-b-frontend
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      b-service:
        condition: service_started
    env_file:
      - ./networks/rollup-b/blockscout-frontend.env

  b-proxy:
    image: nginx:1.27-alpine
    container_name: blockscout-b-proxy
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      b-frontend:
        condition: service_started
      b-service:
        condition: service_healthy
    ports:
      - "29000:80"
    volumes:
      - ./networks/rollup-b/blockscout-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  b-service:
    image: ghcr.io/blockscout/blockscout-optimism:9.0.2
    container_name: blockscout-b
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    depends_on:
      b-db:
        condition: service_healthy
      b-redis:
        condition: service_started
    env_file:
      - ./networks/rollup-b/blockscout.env
    environment:
      RELEASE_LINK: "Compose Rollup B"
    command: >
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    expose:
      - "4000"
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:4000/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  blockscout-a-db:
  blockscout-b-db: