services:
  a-db:
    image: postgres:17
    container_name: blockscout-a-db
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    environment:
      POSTGRES_DB: blockscout
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: blockscout
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -d blockscout"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - blockscout-a-db:/var/lib/postgresql/data

  a-redis:
    image: redis:7-alpine
    container_name: blockscout-a-redis
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  a-service:
    image: ghcr.io/blockscout/blockscout-optimism:${BLOCKSCOUT_VERSION}
    container_name: ${BLOCKSCOUT_A_BACKEND_CONTAINER}
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      a-db:
        condition: service_healthy
      a-redis:
        condition: service_started
    environment:
      CHAIN_ID: "${ROLLUP_A_CHAIN_ID}"
      ETHEREUM_JSONRPC_HTTP_URL: "${ROLLUP_A_ETHEREUM_JSONRPC_HTTP_URL}"
      ETHEREUM_JSONRPC_TRACE_URL: "${ROLLUP_A_ETHEREUM_JSONRPC_TRACE_URL}"
      ETHEREUM_JSONRPC_WS_URL: "${ROLLUP_A_ETHEREUM_JSONRPC_WS_URL}"

      RELEASE_LINK: "Compose Rollup A"
      CHAIN_NAME: "Compose Rollup A"
      NETWORK: "Rollup A"
      SUBNETWORK: "Compose Rollups"
      CHAIN_TYPE: "optimism"
      ETHEREUM_JSONRPC_VARIANT: "geth"
      ETHEREUM_JSONRPC_TRANSPORT: "http"
      DATABASE_URL: "postgresql://blockscout:blockscout@blockscout-a-db:5432/blockscout"
      DATABASE_SSL: "false"
      ECTO_USE_SSL: "false"
      REDIS_URL: "redis://blockscout-a-redis:6379/0"
      SECRET_KEY_BASE: "development"
      PORT: "${BLOCKSCOUT_BACKEND_PORT}"
      POOL_SIZE: "40"
      API_RATE_LIMIT_DISABLED: "true"
    command: >
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    expose:
      - "${BLOCKSCOUT_BACKEND_PORT}"
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:${BLOCKSCOUT_BACKEND_PORT}/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  a-frontend:
    image: ghcr.io/blockscout/frontend:${BLOCKSCOUT_FRONTEND_VERSION}
    container_name: ${BLOCKSCOUT_A_FRONTEND_CONTAINER}
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      a-service:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_HOST: "localhost:${BLOCKSCOUT_A_PUBLIC_PORT}"
      NEXT_PUBLIC_APP_HOST: "localhost:${BLOCKSCOUT_A_PUBLIC_PORT}"
      NEXT_PUBLIC_NETWORK_NAME: "Rollup A Compose"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: "Rollup A"
      NEXT_PUBLIC_NETWORK_ID: "${ROLLUP_A_NETWORK_ID}"
      NEXT_PUBLIC_API_PROTOCOL: "http"
      NEXT_PUBLIC_API_BASE_PATH: ""
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: "ws"
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: "Ether"
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: "ETH"
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: "18"
      NEXT_PUBLIC_APP_PROTOCOL: "http"
      NEXT_PUBLIC_IS_TESTNET: "true"

  a-proxy:
    image: nginx:1.27-alpine
    container_name: blockscout-a-proxy
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      a-frontend:
        condition: service_started
      a-service:
        condition: service_healthy
    ports:
      - "${BLOCKSCOUT_A_PUBLIC_PORT}:80"
    volumes:
      - ${ROLLUP_A_NGINX_CONF}:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s



  b-db:
    image: postgres:17
    container_name: blockscout-b-db
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    environment:
      POSTGRES_DB: blockscout
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: blockscout
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blockscout -d blockscout"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - blockscout-b-db:/var/lib/postgresql/data

  b-redis:
    image: redis:7-alpine
    container_name: blockscout-b-redis
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  b-service:
    image: ghcr.io/blockscout/blockscout-optimism:${BLOCKSCOUT_VERSION}
    container_name: ${BLOCKSCOUT_B_BACKEND_CONTAINER}
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      b-db:
        condition: service_healthy
      b-redis:
        condition: service_started
    environment:
      CHAIN_ID: "${ROLLUP_B_CHAIN_ID}"
      ETHEREUM_JSONRPC_HTTP_URL: "${ROLLUP_B_ETHEREUM_JSONRPC_HTTP_URL}"
      ETHEREUM_JSONRPC_TRACE_URL: "${ROLLUP_B_ETHEREUM_JSONRPC_TRACE_URL}"
      ETHEREUM_JSONRPC_WS_URL: "${ROLLUP_B_ETHEREUM_JSONRPC_WS_URL}"

      RELEASE_LINK: "Compose Rollup B"
      CHAIN_NAME: "Compose Rollup B"
      NETWORK: "Rollup B"
      SUBNETWORK: "Compose Rollups"
      CHAIN_TYPE: "optimism"
      ETHEREUM_JSONRPC_VARIANT: "geth"
      ETHEREUM_JSONRPC_TRANSPORT: "http"
      DATABASE_URL: "postgresql://blockscout:blockscout@blockscout-b-db:5432/blockscout"
      DATABASE_SSL: "false"
      ECTO_USE_SSL: "false"
      REDIS_URL: "redis://blockscout-b-redis:6379/0"
      SECRET_KEY_BASE: "development"
      PORT: "${BLOCKSCOUT_BACKEND_PORT}"
      POOL_SIZE: "40"
      API_RATE_LIMIT_DISABLED: "true"
    command: >
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    expose:
      - "${BLOCKSCOUT_BACKEND_PORT}"
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:${BLOCKSCOUT_BACKEND_PORT}/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  b-frontend:
    image: ghcr.io/blockscout/frontend:${BLOCKSCOUT_FRONTEND_VERSION}
    container_name: ${BLOCKSCOUT_B_FRONTEND_CONTAINER}
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      b-service:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_HOST: "localhost:${BLOCKSCOUT_B_PUBLIC_PORT}"
      NEXT_PUBLIC_APP_HOST: "localhost:${BLOCKSCOUT_B_PUBLIC_PORT}"
      NEXT_PUBLIC_NETWORK_NAME: "Rollup B Compose"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: "Rollup B"
      NEXT_PUBLIC_NETWORK_ID: "${ROLLUP_B_NETWORK_ID}"
      NEXT_PUBLIC_API_PROTOCOL: "http"
      NEXT_PUBLIC_API_BASE_PATH: ""
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: "ws"
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: "Ether"
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: "ETH"
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: "18"
      NEXT_PUBLIC_APP_PROTOCOL: "http"
      NEXT_PUBLIC_IS_TESTNET: "true"

  b-proxy:
    image: nginx:1.27-alpine
    container_name: blockscout-b-proxy
    restart: unless-stopped
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      b-frontend:
        condition: service_started
      b-service:
        condition: service_healthy
    ports:
      - "${BLOCKSCOUT_B_PUBLIC_PORT}:80"
    volumes:
      - ${ROLLUP_B_NGINX_CONF}:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1/api/health"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  blockscout-a-db:
  blockscout-b-db:

networks:
  localnet-l2:
    external: true
    name: localnet-l2