# Flashblocks compose override - adds op-rbuilder and rollup-boost services.
# Architecture: op-node → rollup-boost → op-rbuilder (builder) / op-geth (fallback)

services:
  # Route op-node through rollup-boost
  op-node-a:
    environment:
      OP_NODE_L2_ENGINE_RPC: "http://rollup-boost-a:8551"
    depends_on:
      rollup-boost-a:
        condition: service_started

  op-node-b:
    environment:
      OP_NODE_L2_ENGINE_RPC: "http://rollup-boost-b:8551"
    depends_on:
      rollup-boost-b:
        condition: service_started

  # Block builder for Chain A
  op-rbuilder-a:
    image: ghcr.io/flashbots/op-rbuilder:${OP_RBUILDER_IMAGE_TAG:-latest}
    container_name: op-rbuilder-a
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    volumes:
      - op-rbuilder-a-data:/data
      - ${ROLLUP_A_CONFIG_PATH}:/config:ro
    ports:
      - "17552:8551"  # Engine API
      - "17545:8545"  # HTTP RPC
      - "17111:1111"  # Flashblocks WS
      - "19001:9001"  # Metrics
    command:
      - node
      - --chain=/config/genesis.json
      - --datadir=/data
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.corsdomain=*
      - --http.api=eth,net,web3,debug,txpool
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/config/jwt.txt
      - --metrics=0.0.0.0:9001
      - --flashblocks.enabled
      - --flashblocks.addr=0.0.0.0
      - --flashblocks.port=1111

  # Block builder for Chain B
  op-rbuilder-b:
    image: ghcr.io/flashbots/op-rbuilder:${OP_RBUILDER_IMAGE_TAG:-latest}
    container_name: op-rbuilder-b
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    volumes:
      - op-rbuilder-b-data:/data
      - ${ROLLUP_B_CONFIG_PATH}:/config:ro
    ports:
      - "27552:8551"  # Engine API
      - "27545:8545"  # HTTP RPC
      - "27111:1111"  # Flashblocks WS
      - "29001:9001"  # Metrics
    command:
      - node
      - --chain=/config/genesis.json
      - --datadir=/data
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.corsdomain=*
      - --http.api=eth,net,web3,debug,txpool
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/config/jwt.txt
      - --metrics=0.0.0.0:9001
      - --flashblocks.enabled
      - --flashblocks.addr=0.0.0.0
      - --flashblocks.port=1111

  # Multiplexer for Chain A - routes between op-geth (fallback) and op-rbuilder (builder)
  rollup-boost-a:
    image: flashbots/rollup-boost:${ROLLUP_BOOST_IMAGE_TAG:-latest}
    container_name: rollup-boost-a
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      - op-rbuilder-a
      - op-geth-a
    environment:
      L2_URL: "http://op-geth-a:8551"
      L2_JWT_PATH: "/config/jwt.txt"
      BUILDER_URL: "http://op-rbuilder-a:8551"
      BUILDER_JWT_PATH: "/config/jwt.txt"
      RPC_HOST: "0.0.0.0"
      RPC_PORT: "8551"
      DEBUG_HOST: "0.0.0.0"
      DEBUG_SERVER_PORT: "5555"
      FLASHBLOCKS: "true"
      FLASHBLOCKS_BUILDER_URL: "ws://op-rbuilder-a:1111"
      FLASHBLOCKS_HOST: "0.0.0.0"
      FLASHBLOCKS_PORT: "9999"
      LOG_LEVEL: "info"
    volumes:
      - ${ROLLUP_A_CONFIG_PATH}:/config:ro
    ports:
      - "17551:8551"  # Engine API (op-node connects here)
      - "17555:5555"  # Debug API
      - "17999:9999"  # Flashblocks SSE

  # Multiplexer for Chain B
  rollup-boost-b:
    image: flashbots/rollup-boost:${ROLLUP_BOOST_IMAGE_TAG:-latest}
    container_name: rollup-boost-b
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    depends_on:
      - op-rbuilder-b
      - op-geth-b
    environment:
      L2_URL: "http://op-geth-b:8551"
      L2_JWT_PATH: "/config/jwt.txt"
      BUILDER_URL: "http://op-rbuilder-b:8551"
      BUILDER_JWT_PATH: "/config/jwt.txt"
      RPC_HOST: "0.0.0.0"
      RPC_PORT: "8551"
      DEBUG_HOST: "0.0.0.0"
      DEBUG_SERVER_PORT: "5555"
      FLASHBLOCKS: "true"
      FLASHBLOCKS_BUILDER_URL: "ws://op-rbuilder-b:1111"
      FLASHBLOCKS_HOST: "0.0.0.0"
      FLASHBLOCKS_PORT: "9999"
      LOG_LEVEL: "info"
    volumes:
      - ${ROLLUP_B_CONFIG_PATH}:/config:ro
    ports:
      - "27551:8551"  # Engine API (op-node connects here)
      - "27555:5555"  # Debug API
      - "27999:9999"  # Flashblocks SSE

volumes:
  op-rbuilder-a-data:
  op-rbuilder-b-data:
