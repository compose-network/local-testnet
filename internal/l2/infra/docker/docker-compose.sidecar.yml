services:
  compose-sidecar-a:
    build:
      context: ${COMPOSE_SIDECAR_PATH}/..
      dockerfile: compose-sidecar/build/Dockerfile
    image: local/compose-sidecar:dev
    container_name: compose-sidecar-a
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    ports:
      - "${SIDECAR_ROLLUP_A_API_PORT:-17090}:8090"
    environment:
      SIDECAR_LISTEN_ADDR: ":8090"
      SIDECAR_PUBLISHER_ENABLED: "true"
      SIDECAR_PUBLISHER_ADDR: "http://publisher:8080"
      SIDECAR_CHAIN_ID: "${ROLLUP_A_CHAIN_ID}"
      SIDECAR_CHAIN_RPC: "http://op-rbuilder-a:8545"
      SIDECAR_MAILBOX_ADDRESS: "${MAILBOX_A:-}"
      SIDECAR_COORDINATOR_KEY: "${COORDINATOR_PRIVATE_KEY}"
      SIDECAR_PEER_B_ADDR: "http://compose-sidecar-b:8090"
      SIDECAR_PEER_B_CHAIN_ID: "${ROLLUP_B_CHAIN_ID}"
      SIDECAR_LOG_LEVEL: "debug"
      SIDECAR_LOG_FORMAT: "pretty"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  compose-sidecar-b:
    build:
      context: ${COMPOSE_SIDECAR_PATH}/..
      dockerfile: compose-sidecar/build/Dockerfile
    image: local/compose-sidecar:dev
    container_name: compose-sidecar-b
    labels:
      - "stack=localnet-l2"
    networks:
      - localnet-l2
    ports:
      - "${SIDECAR_ROLLUP_B_API_PORT:-27090}:8090"
    environment:
      SIDECAR_LISTEN_ADDR: ":8090"
      SIDECAR_PUBLISHER_ENABLED: "true"
      SIDECAR_PUBLISHER_ADDR: "http://publisher:8080"
      SIDECAR_CHAIN_ID: "${ROLLUP_B_CHAIN_ID}"
      SIDECAR_CHAIN_RPC: "http://op-rbuilder-b:8545"
      SIDECAR_MAILBOX_ADDRESS: "${MAILBOX_B:-}"
      SIDECAR_COORDINATOR_KEY: "${COORDINATOR_PRIVATE_KEY}"
      SIDECAR_PEER_A_ADDR: "http://compose-sidecar-a:8090"
      SIDECAR_PEER_A_CHAIN_ID: "${ROLLUP_A_CHAIN_ID}"
      SIDECAR_LOG_LEVEL: "debug"
      SIDECAR_LOG_FORMAT: "pretty"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  op-rbuilder-a:
    depends_on:
      compose-sidecar-a:
        condition: service_healthy
    environment:
      SIDECAR_ENDPOINT: "http://compose-sidecar-a:8090"

  op-rbuilder-b:
    depends_on:
      compose-sidecar-b:
        condition: service_healthy
    environment:
      SIDECAR_ENDPOINT: "http://compose-sidecar-b:8090"
